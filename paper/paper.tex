\documentclass[conference]{IEEEtran}
\IEEEoverridecommandlockouts
% The preceding line is only needed to identify funding in the first
% footnote. If that is unneeded, please comment it out.


\usepackage{booktabs}
\usepackage{cite}
\usepackage{url}
\usepackage{multirow}
\usepackage{pgfplots}
\usepackage{tikz}
\usetikzlibrary{matrix,fit,shapes,calc,positioning,shadows,arrows,shapes,backgrounds,decorations.markings,fadings}
\usepackage{listings}
\usepackage[caption=false, font=footnotesize]{subfig}
%%%%%%%%%%%%% code listing
\renewcommand{\ttdefault}{pcr}
\lstset{
  basicstyle=\scriptsize\ttfamily,
  keywordstyle=\scriptsize\ttfamily\bfseries,
  language=C,             % choose the language of the code
  frame=single,              % adds a frame around the code
  aboveskip=0pt,
  belowskip=0pt,
  breaklines=true,           % sets automatic line breaking
  breakatwhitespace=false,   % sets if automatic breaks should only happen at
  showspaces=false,
  %numbersep=5pt,              % Abstand der Nummern zum Text
  %tabsize=2,                  % Groesse von Tabs
  %extendedchars=true,         %
  %breaklines=true,            % Zeilen werden Umgebrochen
  keywords=[2]{tcp, flag, threshold, track, count, seconds, classtype, sid}
}
\usepackage{balance}
\usepackage{wrapfig}
\usepackage{enumitem}
\usepackage{color, colortbl}
\definecolor{Gray}{gray}{0.9}

\input{macros}


%% \usepackage{cite}
%% \usepackage{amsmath,amssymb,amsfonts}
%% \usepackage{algorithmic}
%% \usepackage{graphicx}
%% \usepackage{textcomp}
%% \usepackage{xcolor}

\def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08em
    T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}
\begin{document}

\title{Search-based Synthesis of Network Intrusion Detection Rules}

%%%%%%%%%%% Anonymized

%% \author{\IEEEauthorblockN{1\textsuperscript{st} Given Name Surname}
%% \IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
%% \textit{name of organization (of Aff.)}\\
%% City, Country \\
%% email address}
%% \and
%% \IEEEauthorblockN{2\textsuperscript{nd} Given Name Surname}
%% \IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
%% \textit{name of organization (of Aff.)}\\
%% City, Country \\
%% email address}
%% \and
%% \IEEEauthorblockN{3\textsuperscript{rd} Given Name Surname}
%% \IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
%% \textit{name of organization (of Aff.)}\\
%% City, Country \\
%% email address}
%% \and
%% \IEEEauthorblockN{4\textsuperscript{th} Given Name Surname}
%% \IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
%% \textit{name of organization (of Aff.)}\\
%% City, Country \\
%% email address}
%% \and
%% \IEEEauthorblockN{5\textsuperscript{th} Given Name Surname}
%% \IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
%% \textit{name of organization (of Aff.)}\\
%% City, Country \\
%% email address}
%% \and
%% \IEEEauthorblockN{6\textsuperscript{th} Given Name Surname}
%% \IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
%% \textit{name of organization (of Aff.)}\\
%% City, Country \\
%% email address}
%% }

\maketitle

\begin{abstract}
...
\end{abstract}

\begin{IEEEkeywords}
NIDS, synthesis, search
\end{IEEEkeywords}

\section{Introduction}

Network Intrusion Detection Systems (\nids{}) are software systems
that monitor the network traffic for malicious behavior and act
accordingly by blocking messages or alerting humans about suspicious
events~\cite{Mitchell:2014:SID:2597757.2542049}. \nids{} are typically
placed behind a firewall, vetting the traffic that the firewall did
not block. Various open-source (\eg{}, Snort~\cite{snort} and
Suricata~\cite{suricata}) and commercial implementations (\eg{},
SolarWinds~\cite{solarwinds} and IBM QRadar~\cite{qradar}) exist
today. These systems are very popular in industry to secure local
computer networks given the amount of potential malicious traffic that
exist on the Internet.

\sloppy \nids{} are typically categorized in two
groups~\cite{kumar2007survey}: rule-based and anomaly-based \nids. A
rule-based intrusion detector\footnote{\aka\ signature-based intrusion
  detector.} checks if the network traffic matches a fixed set of
rules. Figure~\ref{fig:synflood-example} shows an example rule of
Suricata~\cite{suricata}, a popular open-source \nids{}. This rule
prescribes a method to capture a denial-of-service
attack~\cite{understanding-dos} to a server by matching specific
conditions about the network traffic. Relevant conditions appear in
bold. Rule-based \nids{} focus on known attacks whereas anomaly-based
\nids{} focus on unknown attacks that could be observed by first
learning the regular traffic and then capturing suspicious
traffic~\cite{kumar2007survey,Mitchell:2014:SID:2597757.2542049,cordy-etal-issta19}.

These two kinds of intrusion detection mechanisms are
complementary. Conceptually, rule-based NIDS could miss attacks (as
rulesets can become outdated) whereas anomaly-based NIDS can raise
false alarms (as the detection algorithms use are approximate).
Rule-based NIDS are restricted to a fixed set of rules and attackers
constantly create new strategies. Furthermore, manually writing rules
to capture those attacks is tedious and error-prone. As consequence,
IT-security companies advertize paid rulesets for consumers to
buy~\cite{proofpoint-etpro,snort-rule-subscriptions}.  Despite this
fundamental issue, rule-based systems are tremendously popular in
industry today~\Fix{cite}. Anomaly-based NIDS, in contrast, are not
restricted to a fixed set of rules. They learn usage behavior from
positive traffic and, based on that, alert uncommon
behavior~\cite{7579764}. Unfortunately, anomaly-based NIDS are
fundamentally imprecise. To sum up, both approaches have positive and
negative aspects.

%% This paper focuses on the
%% problem of discovering new rules by using anomaly-based NIDS.

This paper proposes a technique, dubbed \tname{}, to close the gap
between these two strategies. \tname{} automatically synthesizes rules
from positive and negative examples (\ie{}, benign and malicious
traffic). A scenario of application of \tname{} is one where an
anomaly-based NIDS identifies abnormal traffic and signals that
traffic to \tname{} to craft rules that can be used by rule-based
NIDS. Note that anomaly-based NIDS are evolving pretty quick with the
advances in machine learning, but rule-based NIDS are still extremely
popular.  \tname{} could also leverage existing databases of malicious
traffic to synthesize rules.  Regardless of how the negative traffic
is produced (out of scope of this paper), those rules can be
distributed to rule databases for free. Our goal is to harden the
protection of NIDS by automatically synthesizing rules from negative
examples.

%%  The
%% core motivation is that 1) attackers are productive in creating new
%% ways to circumvent existing protections and 2) manual creation of
%% rules is tedious and time-consuming.  

\Fix{summarize how the technique works}

\Fix{summarize results}

This paper makes the following contributions.

\section{Illustrative Example}
\label{sec:suri-metas-coverage}

\begin{figure}[t]
  \lstinputlisting[language=C,numbers=none,keywords={flags,threshold}]{synflood.suricata}
  \caption{Suricata rule for SYN Flood Attacks.}
  \label{fig:synflood-example}
\end{figure}

This section 1)~shows an example rule of Suricata, 2)~briefly explains
the format of Suricata rules, 3) presents an example of a network
attack, and 4) illustrates how \tname{} performs to synthesize the
rule that would capture the attack.

\subsection{Suricata Rules}
\label{sec:example-suricata-rules}

\Mar{Lucas/Guilherme, verifique se isto esta correto}
Figure~\ref{fig:synflood-example} shows an example rule of
Suricata~\cite{suricata}, a popular open-source \nids{} maintained by
the Open Information Security Foundation (OISF)~\cite{oisf}. A
Suricata rule is divided in three parts---action, header, and rule
options~\cite{suri-rule-format}. The action part appears as the first
word in the rule description. In this case, \CodeIn{alert}. An action
denotes the task that needs to be executed if the rule pattern is
satisfied. In this case, a message will be sent to sys admins if the
rule pattern is satisfied. Other actions include pass, drop, and
reject. The header comes after the action in the rule description. It
restricts the information flow covered by the rule. For this rule, the
header is \CodeIn{tcp \$HOME\_NET any -> \$EXTERNAL\_NET any}, which
instructs Suricata to inspect \CodeIn{tcp} traffic flowing from any
port in the home network to any other address outside the home
network. The variables \CodeIn{\$HOME\_NET} and
\CodeIn{\$EXTERNAL\_NET} are configurable. The rule options come after
the header. It is a semi-colon-separated sequence of options, where
each property is a key-value pair describing a distinct characteristic
of the attack.

\subsection{SYN Flood Attack}

The SYN Flood attack exploits a vulnerability in the TCP/IP handshake
to establish a TCP connection~\cite{cloudfare-synflood}. The handshake
works as follows in normal circumstances. First, a client sends a SYN
packet to the server, requesting a connection. Second, the server
responds with a SYN-ACK packet to the client. Third, the client
responds with an ACK message and the connection is established. Aware
of the protocol, an attacker sends multiple SYN packets to different
ports of a server, often using fake IP addresses. Then, after the
server responds with a SYN-ACK packet, the client keeps sending other
SYN to avoid the connection to time out. Without proper protection,
the server accepts these malicious requests and eventually legitimate
requests cannot be satisfied due to resource exhaustion.

Figure~\ref{fig:synflood-example} shows a Suricata rule to capture
this attack. The critical parts are the option \CodeIn{flags: S,12},
which identifies a SYN packet and the option \CodeIn{threshold: type
  both, track by\_dst, count 5000, seconds 5}, indicating that a high
volume of such packets should be requested in a short period of
time.\Mar{please, explain the other fields}

\subsection{\tname\ on SYN Flood Attack}

\Mar{Guilherme/Lucas (CRI): we need to show how \tname{} works on this
  example. What is the input? How long does it take to generate the
  rule? Is the rule generated exactly the same? Please explain...}
  
\Luc{entrada: utilizamos a ferramenta hping3 para executar o ataque em um alvo arbitrario dentro da rede (n ha necessidade de haver um alvo real para executar o hping3) e capturamos o trafego gerado com o wireshark. o comando utilizado foi:\\*
\texttt{\# hping3 -d 80 -w 64 -S -p 80 --flood --rand-source 192.138.1.115} \\*
que envia pacotes de 120 bytes (-d 120), com a flag SYN habilitada (-S), tamanho de janela de 64 bytes (-w 64), direcionados a porta 80 (-p 80). A flag --flood indica q o hping3 vai enviar os pacotes o mais rápido possível. a flag --rand-source indica que cada pacote vai ter um ip de origem aleatorio. 192.138.1.115 é o alvo.\\*
O trafego armazenado contem 40 mil pacotes SYN, enviados no intervalo de 1 segundo,  pegamos uma amostra de 20 desses pacotes para representar o flood e servir como entrada.\\*

\begin{table*}[t!]
  \caption{\label{table:rules}Rule evolution}  
  \centering
  \begin{tabular}{llllllllllll}
    \toprule
    \multicolumn{1}{c}{Name} & \multicolumn{1}{c}{\#} & \multicolumn{1}{c}{Protocol} & \multicolumn{1}{c}{Description} & \multicolumn{1}{c}{Golden Rule} \\
    \midrule     
    Ping Scan & single & ICMP & Discovers active hosts in a network &  dsize:0; itype:8; \\
    Black Nurse & multiple & ICMP & Denial of Service & itype:3; icode:3; detection\_filter:track by\_dst, count 250, seconds 1;\\
    Ping Flood  & multiple & ICMP & Denial of Service & itype:8; icode:0; detection\_filter:track by\_src, count 30, seconds 1;\\  
    Port Scan TCP & single & TCP & Discovers open ports in a host & flags: A; ack: 0;  \\
    SYN Flood & multiple & TCP & Denial of Service & threshold: type both, track by\_dst, count 5000, seconds 5;\\
    \bottomrule
  \end{tabular}
\end{table*}

regra inicial: -\\*
regra intermediaria: -\\*
regra final: -\\*
iterações para gerar a regra: -

}

\section{Approach}

\begin{figure*}[t]
\centering
\includegraphics[trim=10 360 182 130,clip,width=0.7\textwidth]{figs/nids-workflow}
\caption{\tname\ workflow.}
\label{fig:overview}
\end{figure*}

\tname{} is a search-based approach that uses positive and negative
network examples to synthesize signature-based NIDS rules, such as
those from Snort and Suricata.

The technique synthesizes rules in two steps. First, it produces a
potentially overspecified rule that captures the negative example
provided on input. Then, it uses positive examples to eliminate
unnecessary options from the rule. The goal of \tname\ is to create a
rule that only captures the negative traffic.

Figure~\ref{fig:overview} shows the workflow of \tname{} as a pipeline
of two components, appearing numbered in the figure. Each component
implements one of the steps mentioned above. The goal of the first
component is to produce a rule that captures the negative traffic.
First, it initializes the rule with random values. Only options
associated with the used protocol are included in the rule
representation. Then, \tname\ optimizes the rule options until
\suri\ is able to capture the attack associated with the negative
traffic.  \tname\ unsuccessfully terminates at this point if it cannot
capture the attack. The second component takes as input the rule
produced by the first component and tries to minimize that rule. Note
that any subset of options would capture the negative traffic---as all
options in the rule need to be satisfied for the negative traffic to
be captured---but it can also capture positive traffic. This component
systematically discards options from the rule encoding until no
positive traffic is captured.

\subsection{Problem Characterization}

One important step in search-based optimization is to characterize a
candidate solution to the target problem. Candidate solutions are the
objects that the search optimize towards solutions. In this case, a 
candidate solution is an encoding of a Suricata rule.  \tname\ encodes
the rule options segment of a Suricata rule (see
Section~\ref{sec:example-suricata-rules}) as a vector of Option
objects. Some options are discarded as they only serve for
documentation. For example, the options \CodeIn{msg},
\CodeIn{classtype}, and \CodeIn{misc-activity}, appearing in the
example on Figure~\ref{fig:synflood-example}, have no influence in
triggering the actions associated with the rule. The option
\CodeIn{flags}, however, is relevant to trigger the action. \tname{}
models that option with a data structure storing two fields, one of
character type and another of integer type. This enables \tname{} to
mutate each element separately. Similar encodings are used in modeling
the other relevant options. We found what options are (ir)relevant by
inspecting Suricata code for the presence of \CodeIn{eval} functions,
which are invoked from a main loop to process each action rule. The
presence of such a function for a given option indicates that it is
relevant for triggering some action of some rule.

Options can be specific to a given protocol or general and they can
influence or not triggering an
action. Figure~\ref{fig:distribution-rules-protocol} shows the
distributions of these options per protocol and their relevance for
triggering rule actions.

\pgfplotsset{width=5.5cm,compat=1.8}
\begin{figure}[h!]
  \centering
  \begin{tikzpicture}
    \begin{axis}[
        ybar stacked,
        enlargelimits=0.15,
        legend style={at={(0.5,-0.15)},
          anchor=north,legend columns=-1},
        ylabel={\#rules},
        symbolic x coords={gen, http, icmp, udp, tcp},
        xtick=data,
        nodes near coords,
        nodes near coords align={vertical},
      ]
      \addplot coordinates {(gen,70) (http,34) (icmp,94) (udp,84) (tcp,43)};
      \addplot coordinates {(gen,50) (http,20) (icmp,134) (udp,90) (tcp,123)};    
      \legend{relevant, irrelevant}
    \end{axis}
  \end{tikzpicture}
  \caption{\label{fig:distribution-rules-protocol}Distribution of
    rules per protocol and relevance for triggering action.}
\end{figure}

\subsection{Initial State}

To bootstrap the search, \tname{} needs to select an initial
solution. When creating such candidate solution, \tname{} first looks
for the protocol related to the malicious input traffic. Then, it
selects the relevant options for that protocol and initializes the
option vector with default values. \Mar{Suricata define valores
  default?  Vcs. definiram?  Isto foi baseado em popularidade ou o
  que?}

%% \tname{}
%% uses an abstract representation of a Suricata rule that reflects the
%% concrete representation of the rule. The concrete rule representation
%% is the one actually used by Suricata whereas the abstract
%% representation is the one \tname{} uses to run the search.

\subsection{Fitness Functions}

The fitness value of a candidate solution $c$, modeling the rule
options $o_1, \dots, o_n$ is given by $f(c)=1-\Sigma{d(o_i,m)}/n$,
where $i$ ranges from 1 to $n$ and $m$ denotes the negative
traffic. The higher the fitness value the better, \ie{}, the fitter
the candidate solution $c$ will be.  The value of the expression
$d(o_i,m)$, associated with option $o_i$, ranges over
0-1. Consequently, the value of the expression $\Sigma{d(o_i,m)}/n$
itself is in the 0-1 range, as there are $n$ options, and the range of
the function is 0-1.

As usual, we used customized distance functions to compute $d(o_i,
m)$. For example, let us consider the \CodeIn{flags} option, discussed
on Figure~\ref{fig:synflood-example}. Recall that this option
identifies the SYN packet in the tcp protocol and that its encoding in
\tname{} stores two attributes---one categorical and one
numerical. The value of $d(o_i, m)$, in this case, is obtained by
computing the normalized Euclidean distance in the two-dimensional
space. Considering that each of the two dimensions has cardinality of
ten, the distance of a candidate solution holding the option
\CodeIn{flags(S,13)} to the solution will be 0.22
(=$1/\sqrt{20}$). Note that the smaller the distance the better.

\tname{} uses a modified version of Suricata to measure distance. It
updates the rule set that the modified version of Suricata analyses,
injects the traffic on the network, and monitors the execution. Each
rule option has an associated \CodeIn{eval} function in code. \tname{}
monitors the execution of these functions to identify how far it is
from returning true, which indicates it is closer to trigger the
action associated with the rule. 
\Luc{Originalmente, o suricata interrompe a checagem de uma regra quando alguma das opções não dá match com o pacote analisado. O código fonte foi alterado para que as regras sempre tenham todas as suas opções verificadas. A função de verificação de uma opção retorna um booleano indicando se o valor da opção na regra corresponde ou não ao valor da opção no pacote. Para opções cujos valores são numéricos, alteramos o código fonte para obter a diferença entre os valores da opção na regra e no pacote.
\\*
Exemplo trecho de código original opção "icode":

\begin{figure}[h]
  \lstinputlisting[language=C,numbers=none,keywords={}]{original.code}
  \caption{Original source code.}
  \label{fig:original-code}
\end{figure}

Trecho modificado:

\begin{figure}[h]
  \lstinputlisting[language=C,numbers=none,keywords={}]{modified.code}
  \caption{Modified source code.}
  \label{fig:modified-code}
\end{figure}
    
}

\Fix{Lucas/Guilherme, it would be good to show how this looks like in
  code}

\subsection{Search}

\tname{} is a single-individual hill-climbing like search.


\subsection{Limitations}

\Fix{...}

\section{Evaluation}

%% \renewcommand{\labelitemi}{}
%% \setitemize[0]{leftmargin=20pt,itemindent=-20pt}
%% \begin{itemize}
%% \end{itemize}

%% \renewcommand{\labelitemi}{}
%% \setitemize[0]{leftmargin=0pt,itemindent=0pt}
%% \begin{itemize}
%%   \item{\textbf{RQ1.}~How precise is \tname?}
%%   \item{\textbf{RQ2.}~How efficient is \tname?}
%% \end{itemize}

This section reports precision and efficiency of \tname.


\subsection{Objects of Analysis}

We evaluated \tname{} on a set of attacks covering each of the four
protocols supported by Suricata and attacks with different
characteristics. Table~\ref{table:attacks} shows the attacks we
analyzed and the rule of Suricata that captures the attack. Column
``Name'' shows the name of the attack, column ``\#'' indicates whether
single or multiple messages are required to manifest the attack,
column ``Protocol'' shows the protocol name, column ``Description''
summarizes the effect of the attack, if successfull, and column
``Golden Rule'' shows the relevant parts in the options section of the
Suricata rule that captures the attack.

\begin{table*}[t!]
  \caption{\label{table:attacks}Characterization of attacks analyzed
    and Golden Rule of Suricata (reference) to capture it.\Mar{please,
  show me the Golden Rule, \ie{} the part that is relevant of each rule (for
  capturing the negative traffic precisely)}}  
  \centering
  \begin{tabular}{lllll}
    \toprule
    \multicolumn{1}{c}{Name} & \multicolumn{1}{c}{\#} & \multicolumn{1}{c}{Protocol} & \multicolumn{1}{c}{Description} & \multicolumn{1}{c}{Golden Rule} \\
    \midrule     
    Ping Scan & single & ICMP & Discovers active hosts in a network &  dsize:0; itype:8; \\
    Black Nurse & multiple & ICMP & Denial of Service & itype:3; icode:3; detection\_filter:track by\_dst, count 250, seconds 1;\\
    Ping Flood  & multiple & ICMP & Denial of Service & itype:8; icode:0; detection\_filter:track by\_src, count 30, seconds 1;\\  
    Port Scan TCP & single & TCP & Discovers open ports in a host & flags: A; ack: 0;  \\
    SYN Flood & multiple & TCP & Denial of Service & threshold: type both, track by\_dst, count 5000, seconds 5;\\
    \bottomrule
  \end{tabular}
\end{table*}

\subsection{Setup}

Note from Figure~\ref{fig:overview} that the negative traffic is an
input to the technique. The positive (non malicious) traffic, in
contrast, is not. \tname{} uses public databases storing different
kinds of positive traffic for all protocols covered by Suricata. We
used two datasets of positive traffic. The Bigflows.pcap dataset is
part of the TcpReplay~\cite{tcpreplay} open source project. This
dataset includes real network traffic on a busy private network access
point to the Internet. According to the TcpReplay web site ``This
capture is much larger and has a smaller average packet size than the
previous capture (smallFlows.pcap). It also has many more flows and
different applications.''. In addition to the Bigflows.pcap dataset,
we also used datasets of normal traffic made available by Stratosphere
Lab~\cite{stratosphere-normal}.

%% \Gui{We are using the bigflows.pcap provided by tcpreplay on http://tcpreplay.appneta.com/wiki/captures.html "This is a capture of real network traffic on a busy private network’s access point to the Internet"
%%  }

\Fix{any other detail we should consider?}

\subsection{Precision}

\Fix{...}

\subsection{Efficiency}

\Fix{...}

\section{Threats to Validity}

External Validity. \Fix{elaborate ...how popular are Suricata/Metasploit?}

\section{Related Work}

\Fix{...}

\balance
%\vspace*{-2\baselineskip}
\bibliographystyle{IEEEtran}
\bibliography{references}

\end{document}

%%  LocalWords:  Suricata SolarWinds QRadar NIDS OISF TCP ACK msg tcp
%%  LocalWords:  encodings eval cardinality
